<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUST Student Hub - Smart Library</title>
    <!-- Combined CSS for all sections -->
    <link rel="stylesheet" href="dashboard.css">
</head>

<body>
    <header class="nav-shell">
        <div class="nav-container">
            <a href="/" class="logo-brand">
                <img src="/images/logo.png" alt="MUST">
                <div>
                    <div style="font-weight: 700; font-size: 1.1rem; line-height: 1.2;">MUST Central</div>
                    <div style="font-size: 0.75rem; letter-spacing: 1px; color: var(--accent);">STUDENT PORTAL</div>
                </div>
            </a>

            <nav class="nav-links">
                <a href="javascript:void(0)" class="nav-link active" onclick="loadView('dashboard', this)">Dashboard</a>
                <a href="javascript:void(0)" class="nav-link" onclick="loadView('chatbot', this)">AI Assistant</a>
                <a href="javascript:void(0)" class="nav-link" onclick="loadView('profile', this)">My Library</a>
            </nav>

            <div class="user-meta" id="headerUser">
                <span id="headerName">Student</span>
                <div style="width: 32px; height: 32px; background: var(--accent); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer;"
                    title="Profile">
                    ðŸ‘¤
                </div>
                <button onclick="logout()"
                    style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin-left: 10px; transition: var(--transition);">
                    Logout
                </button>
            </div>
        </div>
    </header>

    <main class="main-stage" id="mainContent">
        <!-- Content will be injected here -->
        <div style="display: flex; justify-content: center; align-items: center; height: 60vh;">
            <p>Loading MUST Student Library...</p>
        </div>
    </main>

    <script>
        // Simple View Router for fragments
        async function loadView(view, element) {
            // Update active link styling
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            if (element) element.classList.add('active');

            try {
                // Fetch the HTML fragment
                const response = await fetch(`${view}_view.html`);
                if (!response.ok) throw new Error('Fragment not found');

                const content = await response.text();
                const contentArea = document.getElementById('mainContent');
                contentArea.innerHTML = content;

                // Extract and execute scripts from the loaded content
                const scripts = contentArea.querySelectorAll('script');
                scripts.forEach(oldScript => {
                    const newScript = document.createElement('script');
                    if (oldScript.src) {
                        newScript.src = oldScript.src;
                    } else {
                        newScript.textContent = oldScript.textContent;
                    }
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });

                // Post-load initialization
                if (view === 'profile') {
                    // Wait a bit for scripts to execute
                    setTimeout(() => {
                        if (typeof updateProfileData === 'function') updateProfileData();
                        if (typeof loadBorrowedBooks === 'function') loadBorrowedBooks();
                    }, 100);
                }
            } catch (error) {
                console.error('Error loading view:', error);
                document.getElementById('mainContent').innerHTML = `
                    <div style="text-align:center; padding-top: 50px;">
                        <h2>Oops! Fragment not found.</h2>
                        <p>Make sure ${view}_view.html exists in the dashboard folder.</p>
                    </div>`;
            }
        }

        // Inject session data into the UI
        function updateProfileData() {
            const name = sessionStorage.getItem('student_name') || 'Guest Student';
            const id = sessionStorage.getItem('student_id') || 'MUST-2024-OFFLINE';

            const profileName = document.getElementById('profileName');
            const profileId = document.getElementById('profileId');

            if (profileName) profileName.textContent = name;
            if (profileId) profileId.textContent = id;
        }

        // Logout function
        function logout() {
            sessionStorage.clear();
            window.location.href = '../must_student_login/login.html';
        }

        // Security Check: Redirect if not logged in
        function checkSession() {
            if (!sessionStorage.getItem('student_id')) {
                window.location.href = '../must_student_login/login.html';
            }
        }

        // Initialize on load
        window.onload = () => {
            checkSession();

            const name = sessionStorage.getItem('student_name') || 'Student';
            document.getElementById('headerName').textContent = name.split(' ')[0]; // Show first name

            // Load dashboard by default
            loadView('dashboard', document.querySelector('.nav-link.active'));
        };
    </script>
</body>

</html>